/*
 * DBExplorer.java
 *
 * Created on September 12, 2001, 3:02 PM
 */

package jdbcdemo;

import javax.swing.tree.*;
import javax.swing.*;
import javax.swing.event.*;
import java.sql.*;

public class DBExplorer extends javax.swing.JApplet {
  // Create tree root
  DefaultMutableTreeNode root = new DefaultMutableTreeNode(
  "No database connected");
  
  // Create the tree model
  DefaultTreeModel treeModel = new DefaultTreeModel(root);
  
  // Database connection and meta data for the connection
  Connection connection;
  DatabaseMetaData dbMetaData;
  
  DBConnectDialog dBConnectDialog1 = new DBConnectDialog();
  
  DBInfoPanel dBInfoPanel1 = new DBInfoPanel();
  TableInfoPanel tableContentPanel1 = new TableInfoPanel();
  
  /** Creates new form DBExplorer */
  public DBExplorer() {
    initComponents();
  }
  
  /** This method is called from within the constructor to
   * initialize the form.
   * WARNING: Do NOT modify this code. The content of this method is
   * always regenerated by the Form Editor.
   */
  private void initComponents() {//GEN-BEGIN:initComponents
        jMenuBar1 = new javax.swing.JMenuBar();
        jMenu1 = new javax.swing.JMenu();
        jmiConnect = new javax.swing.JMenuItem();
        jSeparator1 = new javax.swing.JSeparator();
        jmiExit = new javax.swing.JMenuItem();
        jSplitPane1 = new javax.swing.JSplitPane();
        jTree1 = new javax.swing.JTree();
        jlblStatus = new javax.swing.JLabel();
        
        jMenu1.setText("Connection");
        jmiConnect.setText("Connect to Database");
        jmiConnect.addActionListener(new java.awt.event.ActionListener() {
          public void actionPerformed(java.awt.event.ActionEvent evt) {
            jmiConnectActionPerformed(evt);
          }
        });
        
        jMenu1.add(jmiConnect);
        jMenu1.add(jSeparator1);
        jmiExit.setText("Exit");
        jmiExit.addActionListener(new java.awt.event.ActionListener() {
          public void actionPerformed(java.awt.event.ActionEvent evt) {
            jmiExitActionPerformed(evt);
          }
        });
        
        jMenu1.add(jmiExit);
        jMenuBar1.add(jMenu1);
      
      jTree1.addTreeSelectionListener(new javax.swing.event.TreeSelectionListener() {
        public void valueChanged(javax.swing.event.TreeSelectionEvent evt) {
          jTree1ValueChanged(evt);
        }
      });
      
      jSplitPane1.setLeftComponent(jTree1);
      
      getContentPane().add(jSplitPane1, java.awt.BorderLayout.CENTER);
    
    getContentPane().add(jlblStatus, java.awt.BorderLayout.SOUTH);
    
    setJMenuBar(jMenuBar1);
  }//GEN-END:initComponents
  
  private void jTree1ValueChanged(javax.swing.event.TreeSelectionEvent evt) {//GEN-FIRST:event_jTree1ValueChanged
    TreePath path = jTree1.getSelectionPath();
    if (path == null) return;
    
    String tableName = null;
    
    switch (path.getPathCount()) {
      case 1:
        dBInfoPanel1.setConnection(connection);
        jSplitPane1.setDividerLocation(0.2);
        jSplitPane1.add(dBInfoPanel1, JSplitPane.RIGHT);
        break;
      case 3:
        tableName = (String)(((DefaultMutableTreeNode)
        (path.getPathComponent(2))).getUserObject());
        tableContentPanel1.setConnectionAndTable(
        connection, tableName);
        jSplitPane1.setDividerLocation(0.2);
        jSplitPane1.add(tableContentPanel1, JSplitPane.RIGHT);
        break;
      default:
        jSplitPane1.remove(dBInfoPanel1);
        jSplitPane1.remove(tableContentPanel1);
    }
  }//GEN-LAST:event_jTree1ValueChanged
  
  private void jmiExitActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_jmiExitActionPerformed
    System.exit(0);
  }//GEN-LAST:event_jmiExitActionPerformed
  
    private void jmiConnectActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_jmiConnectActionPerformed
      dBConnectDialog1.setVisible(true);
      
      try {
        connection = dBConnectDialog1.getConnection();
        if (connection != null) {
          dbMetaData = dBConnectDialog1.getConnection().getMetaData();
          jlblStatus.setText("Connected to " + dbMetaData.getURL());
          updateTree();
          jSplitPane1.add(jTree1, JSplitPane.LEFT);
        }
      }
      catch (SQLException ex) {
        jlblStatus.setText(ex.getMessage());
      }
    }//GEN-LAST:event_jmiConnectActionPerformed
    
    private void updateTree() throws SQLException {
      root.setUserObject(dbMetaData.getURL());
      
      ResultSet rsTableTypes = dbMetaData.getTableTypes();
      
      while (rsTableTypes.next()) {
        String tableType = rsTableTypes.getString("TABLE_TYPE");
        
        // Add table names to the tree node under database
        DefaultMutableTreeNode tableTypeNode =
        new DefaultMutableTreeNode(tableType);
        root.add(tableTypeNode);
        
        ResultSet rsTables = dbMetaData.getTables(null, null, null,
        new String[] {tableType});
        
        while (rsTables.next()) {
          String tableName = rsTables.getString("TABLE_NAME");
          // Add table names to the tree node under database
          DefaultMutableTreeNode tableNode =
          new DefaultMutableTreeNode(tableName);
          tableTypeNode.add(tableNode);
          
          ResultSet rsColumns = dbMetaData.getColumns(
          null, null, tableName, null);
          
          // Add column names to the table
          while (rsColumns.next()) {
            tableNode.add(new DefaultMutableTreeNode
            (rsColumns.getString("COLUMN_NAME")));
          }
        }
      }
    }
    
  /** Main method */
  public static void main(String[] args) {
    DBExplorer applet = new DBExplorer();
    javax.swing.JFrame frame = new javax.swing.JFrame();
    frame.setDefaultCloseOperation(javax.swing.JFrame.EXIT_ON_CLOSE);
    frame.setTitle("DBExplorer");
    frame.getContentPane().add(applet, java.awt.BorderLayout.CENTER);
    frame.setSize(400,320);
    java.awt.Dimension d = 
      java.awt.Toolkit.getDefaultToolkit().getScreenSize();
    frame.setLocation((d.width - frame.getSize().width) / 2, 
      (d.height - frame.getSize().height) / 2);
    frame.setVisible(true);
  }    
  
  // Variables declaration - do not modify//GEN-BEGIN:variables
  private javax.swing.JMenuBar jMenuBar1;
  private javax.swing.JMenu jMenu1;
  private javax.swing.JMenuItem jmiConnect;
  private javax.swing.JSeparator jSeparator1;
  private javax.swing.JMenuItem jmiExit;
  private javax.swing.JSplitPane jSplitPane1;
  private javax.swing.JTree jTree1;
  private javax.swing.JLabel jlblStatus;
  // End of variables declaration//GEN-END:variables
}